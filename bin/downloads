#!/usr/bin/env ruby -w

$:.unshift File.join(File.dirname(__FILE__), '..', 'lib')
require 'downloads'

class CLI
  def initialize
    @downloads = Downloads.new
  end

  def extract(message)
    @downloads.extract_attachments(message)
  end

  def fetch(*args)
    case args.first
    when nil
      @downloads.start
    when '--stop'
      @downloads.stop
    else
      usage
    end
  end

  def queue(*args)
    case args.first
    when nil
      @downloads.pending
    when '--check'
      @downloads.check
    when '--clean'
      @downloads.clean
    else
      @downloads.fetch(*args)
    end
  end

  def usage
    puts "Usage:"
    puts "#{$0} extract"
    puts "#{$0} fetch [--stop]"
    puts "#{$0} queue [<url> [-O <filename>]|--check|--clean]"
    exit 1
  end
end

cli = CLI.new
case ARGV.shift
when 'extract'
  cli.extract(ARGF)
when 'fetch'
  cli.fetch(*ARGV)
when 'queue'
  cli.queue(*ARGV)
else
  cli.usage
end